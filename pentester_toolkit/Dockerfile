# Author: Emma Heffernan
# Description: Dockerfile for emmaheff/pentester_toolkit
# Run cmd: docker run -it --rm emmafeff/pentester_toolkit

# Pulling in metasploit framework docker image
FROM metasploitframework/metasploit-framework AS msf
# Using the same version of alpine and ruby as metasploit
FROM ruby:2.7.2-alpine3.12 AS msfbuilder
# Commands taken from: https://github.com/rapid7/metasploit-framework/blob/master/Dockerfile
# On how to copy and install metasploit in a docker container

# This section defines some environment variables which are required to build and install metasploit
# To avoid conflicts environment variables and arguments should always be declared at the start of a section
ENV NMAP_PRIVILEGED=""
ENV APP_HOME=/usr/src/metasploit-framework
ENV METASPLOIT_GROUP=metasploit
ARG BUNDLER_CONFIG_ARGS="set clean 'true' set no-cache 'true' set system 'true' set without 'development test coverage'"
ENV BUNDLE_IGNORE_MESSAGES="true"
# Setting the current directory to $APP_HOME, this is the location of the metasploit source code
WORKDIR $APP_HOME
# Installing some custom packages, including bash, nmap, curl which want to support
# Also installing some missing packages for metasploit build such as libffi-dev and ruby-bigdecimal which without the build fails or metasploit crashes at startup inside the container
RUN apk update && apk add python3 bash nmap curl openssh \
    su-exec ruby ruby-dev libffi-dev ruby-bigdecimal
# Copying the bundle and metasploit source code from the metasploit docker image from the start which was pulled in AS meta
COPY --from=msf /usr/local/bundle /usr/local/bundle
COPY --from=msf ${APP_HOME} ${APP_HOME}

# These commands were taken mostly from the metasploit github Dockerfile
RUN apk add --no-cache \
      autoconf \
      bison \
      build-base \
      ruby-dev \
      openssl-dev \
      readline-dev \
      sqlite-dev \
      postgresql-dev \
      libpcap-dev \
      libxml2-dev \
      libxslt-dev \
      yaml-dev \
      zlib-dev \
      ncurses-dev \
      git \
    && echo "gem: --no-document" > /etc/gemrc \
    && gem update --system \
    && bundle config $BUNDLER_ARGS \
    && bundle install --jobs=8 \
    && rm -rf /usr/local/bundle/cache \
    && chmod -R a+r /usr/local/bundle

FROM ruby:2.7.2-alpine3.12
# Copying environment into new layer
ENV NMAP_PRIVILEGED=""
ENV APP_HOME=/usr/src/metasploit-framework
ENV METASPLOIT_GROUP=metasploit
ARG BUNDLER_CONFIG_ARGS="set clean 'true' set no-cache 'true' set system 'true' set without 'development test coverage'"
ENV BUNDLE_IGNORE_MESSAGES="true"
RUN addgroup -S $METASPLOIT_GROUP
WORKDIR $APP_HOME
RUN apk update && apk add python3 bash nmap curl openssh \
    su-exec ruby ruby-dev libffi-dev ruby-bigdecimal \
    bash sqlite-libs nmap nmap-scripts nmap-nselibs postgresql-libs python2 python3 ncurses libcap su-exec alpine-sdk python2-dev openssl-dev nasm
# Copying from the msfbuilder into current container layers
COPY --from=msfbuilder /usr/local/bundle /usr/local/bundle
COPY --from=msfbuilder ${APP_HOME} ${APP_HOME}

RUN /usr/sbin/setcap cap_net_raw,cap_net_bind_service=+eip $(which ruby)
RUN /usr/sbin/setcap cap_net_raw,cap_net_bind_service=+eip $(which nmap)
RUN chown -R root:metasploit /usr/local/bundle
RUN chown -R root:metasploit $APP_HOME/
RUN chmod 664 $APP_HOME/Gemfile.lock
RUN gem update --system
RUN cp -f $APP_HOME/docker/database.yml $APP_HOME/config/database.yml
RUN curl -L -O https://github.com/pypa/get-pip/raw/3843bff3a0a61da5b63ea0b7d34794c5c51a2f11/get-pip.py && python get-pip.py && rm get-pip.py
RUN pip install impacket
# Setting the root directory back to root "/" for future use
WORKDIR /
# Adding the location of the menu scripts so they can be run from cmd line
RUN export PATH=${PATH}:/home/scripts
# Copying the scripts into the container
COPY scripts/* /home/scripts/
# Defining the entry point of the container as the python menu script
ENTRYPOINT ["python3", "/home/scripts/entrypoint.py"]