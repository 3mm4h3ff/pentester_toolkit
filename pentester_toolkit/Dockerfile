FROM metasploitframework/metasploit-framework AS meta

FROM ruby:2.7.2-alpine3.12 AS builder
ENV NMAP_PRIVILEGED=""
ENV APP_HOME=/usr/src/metasploit-framework
ENV METASPLOIT_GROUP=metasploit
ARG BUNDLER_CONFIG_ARGS="set clean 'true' set no-cache 'true' set system 'true' set without 'development test coverage'"
ENV BUNDLE_IGNORE_MESSAGES="true"

WORKDIR $APP_HOME

RUN export PATH=${PATH}:/home/scripts
RUN apk update && apk add python3 bash nmap curl openssh \
    su-exec ruby ruby-dev libffi-dev ruby-bigdecimal

COPY --from=meta /usr/local/bundle /usr/local/bundle
COPY --from=meta ${APP_HOME} ${APP_HOME}

RUN addgroup -S $METASPLOIT_GROUP

RUN apk add --no-cache bash sqlite-libs nmap nmap-scripts nmap-nselibs postgresql-libs python2 python3 ncurses libcap su-exec alpine-sdk python2-dev openssl-dev nasm

RUN /usr/sbin/setcap cap_net_raw,cap_net_bind_service=+eip $(which ruby)
RUN /usr/sbin/setcap cap_net_raw,cap_net_bind_service=+eip $(which nmap)

RUN apk add --no-cache \
      autoconf \
      bison \
      build-base \
      ruby-dev \
      openssl-dev \
      readline-dev \
      sqlite-dev \
      postgresql-dev \
      libpcap-dev \
      libxml2-dev \
      libxslt-dev \
      yaml-dev \
      zlib-dev \
      ncurses-dev \
      git \
    && echo "gem: --no-document" > /etc/gemrc \
    && gem update --system \
    && bundle config $BUNDLER_ARGS \
    && bundle install --jobs=8 \
    && rm -rf /usr/local/bundle/cache \
    && chmod -R a+r /usr/local/bundle

RUN chown -R root:metasploit /usr/local/bundle
RUN chown -R root:metasploit $APP_HOME/
RUN chmod 664 $APP_HOME/Gemfile.lock
RUN gem update --system
RUN cp -f $APP_HOME/docker/database.yml $APP_HOME/config/database.yml
RUN curl -L -O https://github.com/pypa/get-pip/raw/3843bff3a0a61da5b63ea0b7d34794c5c51a2f11/get-pip.py && python get-pip.py && rm get-pip.py
RUN pip install impacket

WORKDIR /
COPY scripts/* /home/scripts/

ENTRYPOINT ["python3", "/home/scripts/entrypoint.py"]