#!/bin/bash
# Author: Emma Heffernan
# Description: Enables basic reverse ssh

REMOTE_PORT=""
USERNAME=""
REMOTE_SERVER=""
LOCALHOST=""
USER_INPUT="n"
while [ $USER_INPUT != "y" ]; do
    echo "Starting sshd"
    rc-update add sshd
    rc-service sshd start
    echo "Service status"
    rc-status
    read -e -p "Is sshd started? (y/n): " USER_INPUT
done

echo "Setting up ssh user"
read -e -p "Please enter desired username (Default: user): " USERNAME
USERNAME=${USERNAME:-user}
adduser ${USERNAME}
read -e -p "Please enter IP for remote server (Format: <username>:<IP>): " REMOTE_SERVER
read -e -p "Remote port in which to connect to reverse ssh tunnel (Default: 43022): " REMOTE_PORT
REMOTE_PORT=${REMOTE_PORT:-43022}
read -e -p "Enter localhost IP (Default: localhost): " LOCALHOST
LOCALHOST=${LOCALHOST:-localhost}

echo "To connect run the following from the remote server"
echo "ssh ${USERNAME}@${LOCALHOST} -p ${REMOTE_PORT}"
echo "Type 'exit' on both terminal windows to cancel reverse ssh session"

CMD="ssh -R ${REMOTE_PORT}:${LOCALHOST}:22 ${REMOTE_SERVER}"
echo "$CMD"
$CMD